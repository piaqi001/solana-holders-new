<!DOCTYPE html>

<html>
<head>
<meta charset="utf-8"/>
<title>Solana 多代币前 400 持仓查询</title>
<style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    input { padding: 6px; width: 480px; margin-bottom: 10px; display: block; }
    button { padding: 6px 12px; margin-bottom: 20px; }
    h3 { margin-top: 40px; }
    .results-container { display: flex; justify-content: space-between; gap: 20px; }
    .token-column { flex: 1; overflow: auto; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
    th, td { border: 1px solid #ddd; padding: 6px; text-align: center; }
    th { background-color: #f2f2f2; }
    a { color: inherit; text-decoration: underline; }
    .loading { font-style: italic; color: gray; margin-top: 10px; }
    .error { color: red; margin-top: 10px; }
    .color-1 { color: black; }
    .color-2 { color: blue; }
    .color-3 { color: red; }
    #timestamp { margin-top: 10px; font-size: 14px; font-style: italic; color: gray; }
  </style>
</head>
<body>
<h2>Solana 多代币前 400 持仓查询</h2>
<input id="token1" placeholder="请输入第一个代币地址" type="text"/>
<input id="token2" placeholder="请输入第二个代币地址" type="text"/>
<input id="token3" placeholder="可选：第三个代币地址" type="text"/>
<button onclick="handleQuery()">查询</button>
<div class="loading" id="loading" style="display:none;">查询中，请稍候...</div>
<div class="results-container" id="results"></div>
<div id="overlap-container"></div>
<div id="timestamp"></div>
<script>
const addressRemarks = {
  "Be1wABrhNCprQVep99KurhKJWXfQVNAZ1A5DM21Bi7AM": "八月3",
  "EiiAnQsfcruxHFkDabAmH4gzqLUZoEVwRuqEFQGP11xw": "trump大鲸鱼(做市商)"
};

async function handleQuery() {
  document.getElementById("loading").style.display = "block";
  const t1 = document.getElementById("token1").value.trim();
  const t2 = document.getElementById("token2").value.trim();
  const t3 = document.getElementById("token3").value.trim();
  const tokens = [t1, t2, t3].filter(Boolean);
  const results = [];

  for (let token of tokens) {
    const res = await fetch(`/api/holders?token=${token}`);
    const json = await res.json();
    if (!json || !Array.isArray(json)) {
      alert("查询失败或没有持仓数据");
      continue;
    }
    const total = json.reduce((sum, h) => sum + (h.amount || 0), 0);
    json.forEach(h => {
      h.percent = total > 0 ? (h.amount / total * 100) : 0;
    });
    results.push({ name: token.slice(0, 4), holders: json });
  }

  document.getElementById("loading").style.display = "none";
  renderResults(results);
  showOverlap(results);
}

function renderResults(results) {
  const container = document.getElementById("results");
  container.innerHTML = results.map(token => `
    <div class="token-column">
      <h3>${token.name}</h3>
      <table>
        <thead><tr><th>地址</th><th>持仓%</th></tr></thead>
        <tbody>
          ${token.holders.map(h => {
            const remark = addressRemarks[h.wallet] || h.wallet;
            const colorClass = results.filter(r => r.holders.some(x => x.wallet === h.wallet)).length;
            const color = colorClass === 2 ? 'blue' : colorClass === 3 ? 'red' : 'black';
            return `<tr><td><a href="https://solscan.io/account/${h.wallet}" target="_blank" style="color:${color}">${remark}</a></td><td>${h.percent.toFixed(4)}%</td></tr>`;
          }).join('')}
        </tbody>
      </table>
    </div>`).join('');

  document.getElementById("timestamp").innerText = `查询时间：${new Date().toLocaleString()}`;
}

function showOverlap(tokenData) {
  const count = tokenData.length;
  const overlapMap = new Map();

  tokenData.forEach(token => {
    token.holders.forEach(holder => {
      const entry = overlapMap.get(holder.wallet) || { wallet: holder.wallet, count: 0, percents: {} };
      entry.count += 1;
      entry.percents[token.name] = holder.percent;
      overlapMap.set(holder.wallet, entry);
    });
  });

  const overlap = Array.from(overlapMap.values()).filter(e => e.count >= 2);
  if (overlap.length === 0) {
    document.getElementById("overlap-container").innerHTML = "";
    return;
  }

  const tokenNames = tokenData.map(t => t.name);
  let html = `<h3>${count === 2 ? "重叠率统计" : "三重率统计"}</h3>`;
  let totalSum = 0;
  html += `<table><thead><tr><th>#</th><th>地址</th>${tokenNames.map(n => `<th>${n} 持仓%</th>`).join("")}</tr></thead><tbody>`;
  overlap.forEach((o, i) => {
    
const count = o.count;
const name = addressRemarks[o.wallet] || o.wallet;
const color = count === 2 ? 'blue' : count === 3 ? 'red' : 'black';

    const row = tokenNames.map(n => {
      const p = o.percents[n] || 0;
      totalSum += p;
      return `<td>${p.toFixed(4)}%</td>`;
    }).join("");
    html += `<tr><td>${i + 1}</td><td><a href='https://solscan.io/account/${o.wallet}' target='_blank' style='color:${color}'>${name}</a></td>${row}</tr>`;
  });
  html += `</tbody></table>`;
  html += `<p><strong>重叠率总和：</strong>${totalSum.toFixed(4)}%</p>`;
  document.getElementById("overlap-container").innerHTML = html;
}
        </script>
</body>
</html>
