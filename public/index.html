<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Solana 多代币前 400 持仓查询</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    input { padding: 6px; width: 480px; margin-bottom: 10px; display: block; }
    button { padding: 6px 12px; margin-bottom: 20px; }
    h3 { margin-top: 40px; }
    .results-container { display: flex; justify-content: space-between; gap: 20px; }
    .token-column { flex: 1; overflow: auto; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
    th, td { border: 1px solid #ddd; padding: 6px; text-align: center; }
    th { background-color: #f2f2f2; }
    a { color: inherit; text-decoration: underline; }
    .loading { font-style: italic; color: gray; margin-top: 10px; }
    .error { color: red; margin-top: 10px; }
    .color-1 { color: black; }
    .color-2 { color: blue; }
    .color-3 { color: red; }
    #timestamp { margin-top: 10px; font-size: 14px; font-style: italic; color: gray; }
  </style>
</head>
<body>
  <h2>Solana 多代币前 400 持仓查询</h2>
  <input type="text" id="token1" placeholder="请输入第一个代币地址">
  <input type="text" id="token2" placeholder="请输入第二个代币地址">
  <input type="text" id="token3" placeholder="可选：第三个代币地址">
  <button onclick="handleQuery()">查询</button>
  <div id="loading" class="loading" style="display:none;">查询中，请稍候...</div>
  <div class="results-container" id="results"></div>
  <div id="overlap-container"></div>
  <div id="timestamp"></div>
  <script>
    const addressRemarks = {
      "Be1wABrhNCprQVep99KurhKJWXfQVNAZ1A5DM21Bi7AM": "八月3",
      "EiiAnQsfcruxHFkDabAmH4gzqLUZoEVwRuqEFQGP11xw": "trump大鲸鱼(做市商)"
    };

    async function handleQuery() {
      document.getElementById("loading").style.display = "block";
      const t1 = document.getElementById("token1").value.trim();
      const t2 = document.getElementById("token2").value.trim();
      const t3 = document.getElementById("token3").value.trim();

      const tokens = [t1, t2, t3].map(s => s.trim()).filter(s => s.length > 0);
      const results = [];

      for (let token of tokens) {
        const res = await fetch(`/api/holders?token=${token}`);
        const json = await res.json();

        if (!json || !Array.isArray(json)) {
          alert("查询失败或没有持仓数据");
          continue;
        }

        results.push({ name: token.slice(0, 4), holders: json });
      }

      document.getElementById("loading").style.display = "none";
      renderResults(results);
      showOverlap(results);
    }

    function renderResults(results) {
      const container = document.getElementById("results");
      container.innerHTML = results.map(token => `
        <div class="token-column">
          <h3>${token.name}</h3>
          <table>
            <thead><tr><th>地址</th><th>持仓%</th></tr></thead>
            <tbody>
              ${token.holders.map(h => `
                <tr>
                  <td><a href="https://solscan.io/account/${h.wallet}" target="_blank">
                    ${addressRemarks[h.wallet] || h.wallet}</a></td>
                  <td>${(h.percent || 0).toFixed(4)}%</td>
                </tr>`).join('')}
            </tbody>
          </table>
        </div>`).join('');

      document.getElementById("timestamp").innerText = `查询时间：${new Date().toLocaleString()}`;
    }

    function showOverlap(tokenData) {
      const tokens = tokenData;
      console.log("tokenData.length =", tokens.length, tokens.map(t => t.name));
      const container = document.getElementById("overlap-container");
      container.innerHTML = "";

      if (tokens.length === 2) {
        console.log("✅ 正在执行两个代币的重叠率逻辑");
        const holdersA = tokens[0].holders;
        const holdersB = tokens[1].holders;
        const mapA = new Map(holdersA.map(i => [i.wallet, i]));
        const mapB = new Map(holdersB.map(i => [i.wallet, i]));

        let overlap = [];
        let totalOverlap = 0;

        for (const [addr, a] of mapA.entries()) {
          if (mapB.has(addr)) {
            const b = mapB.get(addr);
            const percentA = a.percent || 0;
            const percentB = b.percent || 0;
            totalOverlap += percentA + percentB;
            overlap.push({ addr, percentA, percentB });
          }
        }

        let html = `<h3>重叠率统计</h3>`;
        html += `<p><strong>重叠率总和：</strong>${totalOverlap.toFixed(4)}%</p>`;
        html += `<table><thead><tr><th>#</th><th>地址</th><th>${tokens[0].name} 持仓%</th><th>${tokens[1].name} 持仓%</th></tr></thead><tbody>`;

        overlap.forEach((o, i) => {
          const display = addressRemarks[o.addr] || o.addr;
          html += `<tr><td>${i + 1}</td><td><a href='https://solscan.io/account/${o.addr}' target='_blank'>${display}</a></td><td>${o.percentA.toFixed(4)}%</td><td>${o.percentB.toFixed(4)}%</td></tr>`;
        });

        html += `</tbody></table>`;
        container.innerHTML = html;

      } else if (tokens.length === 3) {
        console.log("⚠️ 错误地进入了三重率逻辑");
        container.innerHTML = `<p>三重率逻辑尚未实现</p>`;
      }
    }
  </script>
</body>
</html>